#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include <sys/wait.h>
#include <unistd.h>

static uint32_t encrypted_password[] = {0x9d1956a1, 0x811d42b1, 0x9c107ba1, 0x942d46a7,
					0xa1107ba5, 0xa1207698, 0xa1207698, 0x8e207698};
static uint32_t key[] = {
	0x00000000,  // Normalement cette valeur est pas utilisée, compteur commence à 1
	// 0x2DD8235E,
	0xC0924F10,
	0xC28CE6AB,
	0xB969BC4B,
	0x628226D7,
	0x57A232BD,
	0x9355C7BB,
	0x0AE40E25,
	0x58D330A2,
	0xF0E16000,
	0x97AFED67,
	0x4E38843B,
	0xC9D943A9,
	0x0FECB0D4,
	0x51BD24A8,
	0x1BF30756,
	0x8329B390,
	0x14217E26,
	0x670EF51C,
	0x6FDDDB72,
	0x5F276DAC,
	0x26127FBC,
	0x56093942,
	0x2C47FFFC,
	0x9DE93A44,
	0xF2AC5588,
	0x34C5CAF8,
	0x9D0C1585,
	0xEA403D29,
	0x758F68D8,
	0x2C07E878,
	0x32E5831D,
	0x92559F31,
	0x07165EFC,
	0xC30A47AA,
	0xB50861C2,
	0xE5E0AABB,
	0xBD8350B0,
	0x8D18FB09,
	0xC8DB7192,
	0x3FCD133F,
	0xB01C6265,
	0xB37B5A8F,
	0xC7D08C32,
	0x70BF3053,
	0x4204788C,
	0x92265731,
	0x7C59D96D,
	0x7BA937B9,
	0x7B9E4175,
	0xA30D274B,
	0x9B03D722,
	0x427BBA0C,
	0x95A49E18,
	0x2F9A01F1,
	0xCD2BE687,
	0x7551D378,
	0x3A6D52EA,
	0x240B8ADE,
	0xA3C264BE,
	0xABB51F23,
	0xC8CD3356,
	0xE31CACBB,
	0x1F13E643,
	0x5315DF8C,
	0x4BDB3CE4,
	0x4905344C,
	0x114E30B6,
	0x11990BE2,
	0x7A9C43CA,
	0x5C3401FA,
	0x9359CDC3,
	0x4D03CEF2,
	0xFE08D05E,
	0x6889CDCA,
	0xC01E37BE,
	0x08521471,
	0xCB503591,
	0x1F27D0BF,
	0x3FC20164,
	0xE677DD16,
	0xD48FFA51,
	0xEEE4CF26,
	0x273D0005,
	0xAE7926E5,
	0x781F98A1,
	0xC3DAF22A,
	0x1BF09859,
	0x885586FC,
	0x23B4105B,
	0x879464F2,
	0x64BD2066,
	0x11A3857E,
	0xF28911BD,
	0x9045A6EB,
	0x6037AECA,
	0x24461745,
	0x6B61C1EC,
	0x5B753EFD,
	0x5F763E94,
	0xDBCF345D,
	0xB4809964,
	0x90C9F965,
	0x03402139,
	0x8AD396EB,
	0xA7784007,
	0xF7861BF4,
	0x36B79DF1,
	0x351F986C,
	0x2DE6A0CF,
	0xD0578F34,
	0xE09C9A41,
	0xF6307F43,
	0x25676731,
	0x12DF97F7,
	0xA63D7A82,
	0x641AC239,
	0x44FA3D69,
	0x0E500192,
	0xF63DAED8,
	0x6E32FD1F,
	0xF5C7FA69,
	0xD78AA06B,
	0xAD77A427,
	0xC2662358,
	0xBEF17670,
	0xE076CB3B,
	0xDF2D927F,
	0xF641430E,
	0x1FD489AD,
	0xBFCC44B9,
	0xC3F0069B,
	0x120E11D3,
	0xA1C7E5FA,
	0xD930E32F,
	0x5FF90343,
	0x70D54086,
	0xF1CB4CF2,
	0x19412F14,
	0x20A2936E,
	0xE88E2179,
	0xFDF40115,
	0xCCB524B6,
	0x8F104C05,
	0x0475152A,
	0xFD1C853A,
	0x1CF817F5,
	0x266FF649,
	0x12A40E91,
	0x9E040891,
	0xD578C507,
	0x52896CD2,
	0x0443B3AD,
	0xA7ED1A3B,
	0x234D5F34,
	0xC7C2C9B7,
	0xB53E9EF0,
	0x57493E38,
	0x8AC86B23,
	0xCFB9C119,
	0xFB539806,
	0xF8DC91A6,
	0x69B793C9,
	0x1CBCE8A4,
	0x1E5FA7BD,
	0x2B9E02B2,
	0x66DBF4CB,
	0x23FE18F7,
	0xF5A8BF93,
	0xB4154CB0,
	0x648EDBDD,
	0x3DFDC07D,
	0x8B8C0E0B,
	0xEBAB2634,
	0xEE9D61E4,
	0x9D026FEF,
	0xAB05F63F,
	0x1171FE0F,
	0xA3CE3CE2,
	0x96FF4075,
	0x7F6A5AFD,
	0x528B1EE0,
	0xF0A695C2,
	0xA0DE199E,
	0xED5DFF9A,
	0x2DA84C6A,
	0xE11C1D17,
	0x2BE16450,
	0x34B0CD02,
	0xE3338623,
	0xD459CBD6,
	0x815BECF9,
	0xFED1C775,
	0xB0BC8BCC,
	0xB61FE5DD,
	0x5992FC7D,
	0x5A6ADA79,
	0x8CF5ED81,
	0x5A5047B0,
	0x28B4747A,
	0x46F4A0E8,
	0x943BFFB3,
	0xF67CDD26,
	0x6C7DC615,
	0xE6552219,
	0x023586AE,
	0x8A02E134,
	0x8EF9EEE9,
	0x1C1B66C2,
	0x544D6DFC,
	0x81029883,
	0xD34C430C,
	0x743AFD3E,
	0x698E5405,
	0x8B9C68AB,
	0xCE4006BE,
	0x97A0ED28,
	0x7362E32D,
	0x4E9D4B07,
	0x7F715CF8,
	0xC05405D0,
	0xC8AFB503,
	0xD52074C2,
	0x23F6D031,
	0xDD09D6DE,
	0x58ECDCEB,
	0xECB46D73,
	0xFE77FA11,
	0x87E40023,
	0x68FB2489,
	0x1D65B3C6,
	0xA8B18D96,
	0xDF097262,
	0xFFD73545,
	0x40950805,
	0xD524BA43,
	0x5EFA302C,
	0x74A68024,
	0x337A19C0,
	0x2CAB41CB,
	0x25EF61B5,
	0x7C10E174,
	0x987B5B0B,
	0xC6882347,
	0x07F0F663,
	0x75F9ED70,
	0x51932468,
	0xEBEEC3B5,
	0xC34EB759,
	0xA5537759,
	0x97324351,
	0xCBD30D95,
	0x17E9082B,
	0x8D1288DE,
	0x3666BE33,
};

int main(void) {
	char user_input[256];
	unsigned compteur = 0;
	printf("Mot de passe : ");
	fgets(user_input, sizeof(user_input), stdin);

	char* newline = strstr(user_input, "\n");
	if (newline) {
		*newline = 0;
	}

	while (1) {
		pid_t child_pid = fork();
		if (child_pid < 0) {
			perror("fork");
			return -1;
		} else if (child_pid == 0) {
			compteur += 1;
			for (size_t i = 0; i < sizeof(encrypted_password) / sizeof(uint32_t); i++) {
				encrypted_password[i] ^= key[compteur];
			}

			if (strlen(user_input) == sizeof(encrypted_password) &&
			    memcmp(encrypted_password, user_input, sizeof(encrypted_password)) == 0) {
				printf("Mot de passe correct !\n");
				return 0;
			} else if (compteur >= sizeof(key) / sizeof(uint32_t)) {
				printf("Mot de passe incorrect !\n");
				return 1;
			}
		} else {
			int wstatus;
			if (waitpid(child_pid, &wstatus, 0) < 0) {
				perror("waitpid");
				return -1;
			}
			return WEXITSTATUS(wstatus);
		}
	}
}
